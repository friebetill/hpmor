\documentclass[11pt,extrafontsizes,twoside,openany,final]{memoir}

% THIS DOCUMENT REQUIRES LuaLaTeX TO COMPILE! XeLaTeX should work but formatting might be subpar.

\usepackage{lettrine}		% Used for the fancy caps at the start of each chapter
\usepackage{amsmath}		% Provides the align environment, used in chapter 13 for the notes
\usepackage[protrusion=basictext]{microtype}
                            % Makes right margin neater by letting certain punctuation protrude slightly
\usepackage{fontspec}		% For the many fonts

\usepackage{xstring}        % Needed for \IfInteger...
\usepackage{censor}         % Used in "Time Pressure" to redact a name

\usepackage[bookmarks=true,unicode=true,pdfborder={0 0 0},
	pdftitle={Harry Potter and the Methods of Rationality},
	pdfauthor={LessWrong}, breaklinks={true},
	pdfkeywords={Harry Potter, rationality},pdfencoding=auto
]{hyperref}                 % Hyperlinks and bookmarks in PDF

\usepackage{ellipsis}        % Must be loaded after fontspec and hyperref
\renewcommand{\ellipsisgap}{.16667em}

\usepackage[style=english]{csquotes}
\MakeOuterQuote{"}	    % Automatic open and closing quotes

\usepackage{fmtcount}       % Provides \NUMBERstringnum
\usepackage{graphicx}       % for \reflectbox in header
\usepackage[normalem]{ulem} % For \censor in chapter 64

% \overfullrule=5pt % Mark overfull hbox with black rectangle

% Make framed boxes (for debugging) take no additional space
% \fboxrule=1pt
% \fboxsep=-1pt

%
% Set-up page sizes and margins
%
%\setstocksize{205mm}{135mm}
%\settrimmedsize{\stockheight}{\stockwidth}{*}
%\settrims{0mm}{0mm}
\setstocksize{211mm}{141mm}% Size of paper fed to the printer
\settrimmedsize{205mm}{135mm}{*}% Size of paper after trimming the edges
\settrims{3mm}{3mm}% Amount trimmed from the top and fore-edge
\settypeblocksize{164mm}{107mm}{*} % Size of main text (will be adjusted below)
%\setbinding{5mm}% Space reserved on spine side for binding: not used, margins set explicitely
%\setlrmargins{*}{*}{1.1}% Ratio between spine and edge margins: unused, margins set explicitely
% Spine and fore-edge margins: spine margin should look a bit smaller (as there
% are two next to each other) but we must account for the binding. These might
% cancel out.
\setlrmarginsandblock{17mm}{17mm}{*}
\setulmargins{*}{*}{1.2}% Ratio between up and down margins
\setheadfoot{\baselineskip}{2\baselineskip}% Header height and skip from text bottom to footer bottom
\setheaderspaces{*}{*}{*}% Equal spacing above and below header
\settypeoutlayoutunit{mm}% Print dimensions in millimeters in compilation output
\checkandfixthelayout% Apply the layout

%
% Font setup: URW Garamond No. 8
%
\setmainfont[
, ExternalLocation=fonts/garamond/
, Ligatures={Common,TeX}
, UprightFont=*-Regular
, ItalicFont=*-Italic
, BoldFont=*-Medium
, BoldItalicFont=*-Medium-Italic
]{GaramondNo8}
%
% Chapters, headings, etc.: Lumos (extra spacing looks much better)
\newfontface\hp[ExternalLocation=fonts/, LetterSpace=10.0, WordSpace=2.0]{Lumos}
\newcommand{\lumos}[1]{{\hp\MakeUppercase{#1}}}
% Chapter numbers: Lumos (extreme spacing for effect)
\newfontface\hpchap[ExternalLocation=fonts/, LetterSpace=60.0, WordSpace=7.0]{Lumos}
%
% Font used to draw the magic star
\newfontface\starfont[ExternalLocation=fonts/]{Miscelanea.ttf}
%
% Draws a “magic star”, used as a decoration
\newcommand*{\Star}{{\starfont{}*}}
%
% Draws three “magic stars”, used as a decoration everywhere
\newcommand*{\Stars}{{\large\Star\kern-.6ex\lower1.3ex\hbox{\large\Star}%
    \kern-.1ex\raise.2ex\hbox{\tiny\Star}\spacefactor1000}}
%
% Parseltongue
\newfontface\ptsansi[
, ExternalLocation=fonts/alegreya-sans/
, Ligatures={Common,TeX}
, UprightFont=*-Light
, ItalicFont=*-LightItalic
, BoldFont=*-Regular
, BoldItalicFont=*-Italic
]{AlegreyaSans}

%
% Section break with three spaced stars
%
\newcommand{\sbreak}{%
    \par\vskip 0pt plus .5\baselineskip
    {\begin{center} \Star\qquad\Star\qquad\Star \end{center}}%
    \vskip 0pt plus .5\baselineskip \par\noindent}

%
% Custom chapter style
%
\makechapterstyle{evans}{%
	\renewcommand*{\chapnamefont}{\hpchap\normalsize}
	\renewcommand*{\chapnumfont}{\chapnamefont\normalsize}
	\renewcommand*{\chaptitlefont}{\hp\large}
	
	\setlength{\beforechapskip}{0pt}
	\setlength{\midchapskip}{0pt}
	\setlength{\afterchapskip}{1\baselineskip}
	
	\renewcommand*{\printchapternum}{% " C H A P T E R   O N E "
		\begin{center} \chapnumfont \hyperref[contents]{CHAPTER \NUMBERstringnum{\thechapter}}\end{center}}

	\renewcommand*{\printchaptername}{}% Not needed, "CHAPTER" added above
	
	\renewcommand*{\printchaptertitle}[1]{% "A DAY OF VERY LOW PROBABILITY"
		\vskip 1cm \begin{center}\chaptitlefont \MakeUppercase{##1}\end{center}\par \vskip 1cm}
	
	\renewcommand*{\chaptermark}[1]{% "CHAPTER ONE" and "A DAY OF..."
		\markboth{\MakeUppercase{\chaptername}~\thechapter}%
			{\MakeUppercase{##1}}}

	\renewcommand*{\tocmark}{\markboth{}{\MakeUppercase{Contents}}}
	
	\renewcommand{\tocheadstart}{\chapterheadstart}
	\renewcommand{\aftertoctitle}{\thispagestyle{empty}\afterchaptertitle}
}
\chapterstyle{evans}% Actually implements the above chapter style code

% Macro to convert a number to uppercase Roman
\makeatletter
\newcommand*{\RomNum}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother

% Command to choose where to break the line in long chapter titles
\newcommand*{\wrapchapter}[2]{
	\chapter[#1 #2]           % TOC and page header
	{#1\protect\linebreak #2}}% Title

% Macro to format an abbreviation such as "TSPE" for "the Stanford Prison Experiment"
\newcommand{\abbrev}[1]{{\scshape \MakeLowercase{#1}}}

% Formatting of the part numbers.
% Numbers are formatted as roman numerals (0 is left unchanged).
% Non-numbers are also left unchanged, and without a "Part~" prefix. This is used for chapter 77.
% This implementation is expandable and so causes no issue with hyperref.
\newcommand{\formatPart}[1]{\ifnum0<0#1\relax Part~\RomNum{#1}\else \if 0#1\relax Part~0\else #1\fi\fi}
\newcommand{\formatPartShort}[1]{\ifnum0<0#1\relax \RomNum{#1}\else #1\fi}% Same case for 0 and non-numeric

% \partchapter{The Stanford Prison Experiment}{1}
% TOC: The Stanford Prison Experiment, Part I
% Page header: The Stanford Prison Experiment I
% Title: The Stanford Prison Experiment, Part I
\newcommand{\partchapter}[2]{%
	\chapter[#1, \formatPart{#2}]%
		[#1 \formatPartShort{#2}]%
		{#1, \formatPart{#2}}}

% \namedpartchapter{Taboo Tradeoffs}{2}{The Horns Effect}
% TOC: Taboo Tradeoffs, Part II: The Horns Effect
% Page header: Taboo Tradeoffs II: The Horns Effect
% Title: Taboo Tradeoffs, Part II: \\? The Horns Effect
% The optional argument affects whether the line is broken after "Part ...:"
\newcommand{\namedpartchapter}[5][1]{%
	\chapter[#2, \formatPart{#3}: #4]%
		[\mbox{#2 \formatPartShort{#3}:} \mbox{#4}]%
		{#2, \formatPart{#3}:\protect\linebreak[#1] #4}}

% \abbrevnamedpartchapter{The Stanford Prison Experiment}{TSPE}{6}{Constrained Optimization}
% TOC: \abbrev{TSPE}, Part VI: Constrained Optimization
% Page header: TSPE VI: Constrained Optimization
% Title: The Stanford Prison Experiment, Part VI: \\? Constrained Optimization
% The optional argument affects whether the line is broken after "Part ...:"
\newcommand{\abbrevnamedpartchapter}[6][1]{%
	\chapter[\texorpdfstring{\abbrev{#3}, \formatPart{#4}: #5}{#3, \formatPart{#4}: #5}]%
		[\mbox{#3 \formatPartShort{#4}:} \mbox{#5}]%
		{#2, \formatPart{#4}:\protect\linebreak[#1] #5}}

%
% Subsection
%
\setsubsecheadstyle{\scshape} % Subsection titles in small caps
\beforesubsecskip=1.5\baselineskip % skip before the heading
\aftersubsecskip=.5\baselineskip plus .5\baselineskip % skip after the heading
\setsubsechook{\nopagebreak\vskip 0pt plus 3\baselineskip}

%
% Configure line spacing and paragraph spacing, and modifying penalties
%
\linespread{1.11} % Wider line spacing looks much better
\raggedbottom     % Better to have consistent line spacing than vertically justified text
%\sloppybottom     % Allows widow lines to be added to the bottom of the page.
\frenchspacing    % Single space after a period
%
\setlength{\emergencystretch}{.07\textwidth}
% If a paragraph cannot be typeset without compromises, try wider line spacing
%
\clubpenalty=80 % Mildly discourages first line of paragraph on previous page
\widowpenalty=4000 % Avoids last line of paragraph on next page
\brokenpenalty=9000 % Avoids hyphenation across a page break
\hyphenpenalty=70 % Penalty for automatic hyphenation
\exhyphenpenalty=90 % Penalty for breaking after a dash or explicit hyphen
\doublehyphendemerits=90000 % Avoids hyphenation on consecutive lines
\hbadness=4000 % When compiling, only reports underfull lines if badness>4000

%
% Adjust space around lists (not entirely sure why)
%
\setlength{\topsep}{.5\baselineskip plus 1\baselineskip minus .5\baselineskip}
\setlength{\partopsep}{.5\baselineskip plus 1\baselineskip minus .5\baselineskip}

%
% Lettrine font pick and configuration
%
\renewcommand{\LettrineFontHook}{\hp} % Uses Lumos for the large letter
\renewcommand{\LettrineTextFont}{} % Normal font for the rest of the first word
% For when the first word is in italics, use this command instead
\newcommand{\lettrinemph}[3][]{\lettrine[#1]{#2}{\emph{#3}}}
\setcounter{DefaultLines}{1}
% Large cap instead of drop cap because of many short first lines
\renewcommand{\DefaultLoversize}{0}
\renewcommand{\DefaultLraise}{0}

%
% Page numbering, footer, header
%
\newcommand{\pageInFooter}{{\small\makebox[2em][c]{\thepage}}}
% Page number centered in footer
% Same on all pages in body text
\makeevenfoot{plain}{}{\pageInFooter}{}
\makeoddfoot{plain}{}{\pageInFooter}{}
\makeevenfoot{headings}{}{\pageInFooter}{}
\makeoddfoot{headings}{}{\pageInFooter}{}
%
% Left side header: chapter number
% Right side header: chapter name
\makeevenhead{headings}{}{\hp\hyperref[contents]{\scriptsize\leftmark}}{}
\makeoddhead{headings}{}{\hp\scriptsize\rightmark}{}

% Style definitions and hacks
%
% In the text, the ellipsis is encoded with \el, which we define here to \dots
% preceded by the same amount of space as used between the dots (see the
% ellipsis package configuration above). Note that the ellpsis package is
% necessary for \dots to generate three spaced dots when compiling with
% lualatex or xelatex (otherwidse one gets a single glyph of 3 packed dots). We
% use \dots instead of \ldots because of a buggy interaction with the amsmath
% package.
\newcommand*{\el}{\kern \ellipsisgap\dots} % Ellipsis definition
%
% Logical formatting macros
\newcommand*\parsel[1]{{\ptsansi\textit{#1}}} % Parseltongue
\newcommand*{\prophecy}[1]{\textsc{#1}} % Prophecies
\newcommand*{\headline}[1]{\begin{center}\textsc{#1}\end{center}} % Newspaper headlines
\newcommand*{\inlineheadline}[1]{\textsc{#1}} % Newspaper headlines inline with text
%
% Macros for time of day. Using '/' suffix to avoid eating a following space.
\def\AM/{{\,\scshape am}} % AM in small caps
\def\PM/{{\,\scshape pm}} % PM in small caps
%
% Makes a written note in italics (first used, Hogwarts acceptance letter)
\newenvironment{writtenNote}{%\parindent=1cm%
	\vskip 1\baselineskip plus 1\baselineskip minus .5\baselineskip%
	\begin{adjustwidth}{\parindent}{\parindent}\begin{em}%
	\par\noindent}
	{\end{em}\end{adjustwidth}\vskip 1\baselineskip plus 1\baselineskip minus .5\baselineskip}
% Makes a letter address and closing, for use with above writtenNote environment
\newcommand{\letterAddress}[1]{\pagebreak[1]\noindent{}#1\nopagebreak[4]\par}
\newcommand{\letterClosing}[2][\vskip 1\baselineskip]{\nopagebreak[4]#1\par\nopagebreak[5]\noindent#2}
%
% Whiteboard in chapter 15 "Transfiguration is not permanent!"
\newcommand{\hackChXV}[1]{
\vskip 0pt plus .5cm
\begin{center}
\underline{\MakeUppercase{#1}}
\end{center}
\vskip 0pt plus .5cm
}
%
\newcommand{\hackChDXIV}[2]{%
%~ \vskip 0\baselineskip plus 1\baselineskip
\noindent\hfill\scalebox{#2}{#1}\hfill\mbox{}%
\vskip 1\baselineskip plus 1\baselineskip
}
%
\newlength{\Auxa}
\newcommand{\hackChDXIVa}{
\fontspec[ExternalLocation=fonts/]{RingBearer}
\settowidth{\versewidth}{\mbox{the}}
Lord\scalebox{.40}{\parbox[b]{\versewidth}{
	\centering of\\\nointerlineskip\vskip 4pt the}}Rationalit\raisebox{-.32ex}{Y}
}
%
\newcommand{\hackChDXIVb}{
\fontspec[ExternalLocation=fonts/]{NarniaBLL}
456}
%
\newcommand{\hackChDXIVd}{
\fontspec[ExternalLocation=fonts/]{Thundercats}
ThunderSmarts}
%
\newcommand{\hackChDXIVh}{
\fontspec[ExternalLocation=fonts/]{Twilight}
Utilitarian Twilight}


% Hyphenation corrections
%
\hyphenation{Her-mi-o-ne Gran-ger bru-shes Gryf-fin-dor Le-strange 
some-where which-ev-er Hog-warts re-pli-cat-ed ran-dom sta-tis-ti-cal 
Wi-zen-gam-ot an-aly-se an-aly-sis re-mem-ber McGon-a-gall fun-da-men-tal
Dum-ble-dore thou-sand}
